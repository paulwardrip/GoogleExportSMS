<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.2.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
    <script src="xmljson.js"></script>
    <script src="centerize.js"></script>
</head>
<body>
    <div class="holding" style="display: none"></div>
    <div class="lefty" style="display: inline-block">
    <textarea id="xml"></textarea>
        <br/><a id="dlxml" style="display: none">Download XML</a>
    </div>
    <div class="righty" style="display: inline-block">
    <textarea id="text"></textarea>
        <br/><a id="dltxt" download='messages.txt' style="display: none">Download Text</a>
    </div>
</body>
<script>
    $(document).ready(function () {

        $(".lefty").widthPercent(.49);
        $(".righty").widthPercent(.49);
        $(".lefty").heightPercent(.9);
        $(".righty").heightPercent(.9);

        $("#xml").widthPercent(.85, ".lefty");
        $("#text").widthPercent(.85, ".righty");
        $("#xml").heightPercent(.85, ".lefty");
        $("#text").heightPercent(.85, ".righty");

        var _n = navigator.userAgent.toLowerCase().indexOf("windows") > -1 ? "\r\n" : "\n";

        var config, convos, convos_count;

        function guid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                    .toString(16)
                    .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                s4() + '-' + s4() + s4() + s4();
        }

        var str = "";
        var messages = {
            "xml-stylesheet": {
                directive: true,
                attributes: {
                    type: "text/xsl",
                    href: "sms.xsl"
                }
            },
            smses: {
                attributes: {
                    backup_date: new Date().getTime(),
                    backup_set: guid(),
                },
                sms: []
            }
        };

        function numberFinder() {
            var breaker = false;

            var cn = this;
            var fn = $(this).find("div.fn");

            console.log(convos_count, fn.text());
            if (fn.text().match(/[0-9]{4,11}$/)) {
                found(fn.text(), fn.text(), cn);

            } else {
                var elems = $(this).find("a.tel"), tel_count = elems.length;

                console.log("Looking for Recipient Number.");

                function cvs() {
                    var phone = $(this).attr("href");
                    if (!breaker) {
                        if (phone.indexOf(config.mynumber) == -1) {
                            number = phone.replace(/tel./, "");
                            console.log("Found Number:", number);
                            breaker = true;
                            found(number, fn.text(), cn);
                        }
                    }

                    if (!breaker && !--tel_count) {
                        console.log("Finished tels", fn.text());

                        var velem = $("div.vcards a.tel"), v_count = velem.length;
                        velem.each(function () {
                            if (fn.text() == $(this).html()) {
                                found($(this).attr("href"), fn.text(), cn);
                            }

                            if (!--v_count){
                                console.log("Can't find", fn.text());
                                found();
                            }
                        });
                    }
                }

                elems.each(cvs);
            }

        }

        $.get("../config.json").done(function (_config) {
            config = _config;
            console.log("Config Loaded.");

            $.get("voice-export.html?nocache=" + moment().valueOf()).done(function (_html) {
                console.log("Voice Backup HTML Loaded.");
                $(".holding").append(_html);


                convos = $("div.conversation"), convos_count = convos.length;

                convos.each(numberFinder);
            });

        });

        function report() {
            console.log("Report", convos_count);
            if (!--convos_count) exporter();
        }

        function found(number, fn, cnv) {
            if (number != null) {
                var elems = $(cnv).find("div.message"), count = elems.length;
                console.log(count, "messages ready to import.");

                if (elems.length == 0) --count;

                elems.each(function () {
                    //console.log("Converting message " + (elems.length - count) + " of " + elems.length);

                    let tel = $(this).find("cite.sender.vcard a.tel").attr("href");
                    let wasme = tel.indexOf(config.mynumber) > -1;

                    var m = moment($(this).find("abbr").attr("title"));

                    str += m.format("MMM D, YYYY h:mm A") + "\t" +
                        (wasme ? config.myname : fn) + "\t" +
                        $(this).find("q").html() + _n;

                    var sms = {attributes: {}};
                    sms.attributes.protocol = 0;
                    sms.attributes.address = number;
                    sms.attributes.date = m.valueOf();
                    sms.attributes.type = wasme ? 2 : 1;
                    sms.attributes.contact_name = fn.match(/[0-9]{10,11}/) ? null : fn;
                    sms.attributes.body = $(this).find("q").html().replace(/\"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "");
                    sms.attributes.toa = "null";
                    sms.attributes.sc_toa = "null";
                    sms.attributes.service_center = "null";
                    sms.attributes.read = "1";
                    sms.attributes.status = "-1";
                    sms.attributes.locked = "0";
                    sms.attributes.date_sent = "0";
                    sms.attributes.readable_date = m.format("MMM D, YYYY h:mm A");

                    messages.smses.sms.push(sms);

                    if (!--count) report();
                });
            }
        }

        function exporter() {
            console.log("Exporting XML");
            var xml = xmljson.toXML(messages);
            var href = "data:text/xml;charset=utf-8;base64," + btoa(unescape(encodeURIComponent(xml)));
            $("#dlxml").attr("download", "sms-" + moment().format("YYYYMMDDhhmmss") + ".xml");
            $("#dlxml").attr("href", href).show();

            $("#xml").val(xml);

            var href2 = "data:text/plain;charset=utf-8;base64," + btoa(unescape(encodeURIComponent(str)));
            $("#dltxt").attr("href", href2).show();

            $("#text").val(str);

            console.log("Ready");

        }
    });
</script>
</html>